{% extends 'webapp/base_webapp.html' %}

{% block title %}Mangi POS - Suppliers Management{% endblock %}

{% block additional_styles %}
.supplier-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.supplier-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.tag-active {
    background-color: #d4f5e2;
    color: #00b248;
}

.tag-inactive {
    background-color: #f5f5f5;
    color: #757575;
}

.tag-pending {
    background-color: #ffe8d9;
    color: #ff5722;
}

.brand-gradient-light {
    background: linear-gradient(to right, #EE4540, #C72C41);
}
{% endblock %}

{% block content %}
<!-- Main Content Container -->
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Suppliers Header -->
    <div class="brand-gradient rounded-lg shadow px-5 py-4 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white">Suppliers Management</h1>
                <p class="text-white opacity-80">Manage your suppliers and vendor relationships</p>
            </div>
            <div class="flex items-center space-x-3">
                <button class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-md flex items-center" id="addSupplierBtn" title="Add new supplier">
                    <i class="fas fa-plus mr-2"></i> Add Supplier
                </button>
                <form method="get" action="{% url 'webapp:suppliers' %}" class="inline-block">
                    {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                    <select class="bg-white bg-opacity-20 text-white border-0 rounded p-2" name="supplier_type" onchange="this.form.submit()" title="Filter suppliers by type">
                        <option value="all" {% if supplier_type_filter == 'all' %}selected{% endif %}>All Suppliers</option>
                        {% for key, value in supplier_type_choices.items %}
                        <option value="{{ key }}" {% if supplier_type_filter == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Suppliers Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Suppliers -->
        <div class="bg-white rounded-lg shadow p-6 supplier-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Suppliers</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">{{ total_suppliers }}</h3>
                    <p class="text-{% if new_suppliers_this_month > 0 %}green{% else %}red{% endif %}-500 text-sm font-medium mt-2">
                        <i class="fas fa-arrow-{% if new_suppliers_this_month > 0 %}up{% else %}down{% endif %} mr-1"></i> {{ new_suppliers_this_month }} <span class="text-gray-400">new this month</span>
                    </p>
                </div>
                <div class="h-14 w-14 bg-primary-light bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-truck text-primary-light text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Active Suppliers -->
        <div class="bg-white rounded-lg shadow p-6 supplier-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Active Suppliers</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">{{ active_suppliers }}</h3>
                    <p class="text-{% if active_change_percent > 0 %}green{% elif active_change_percent < 0 %}red{% else %}gray{% endif %}-500 text-sm font-medium mt-2">
                        <i class="fas fa-arrow-{% if active_change_percent > 0 %}up{% elif active_change_percent < 0 %}down{% else %}right{% endif %} mr-1"></i> {{ active_change_percent_abs }}% <span class="text-gray-400">{% if active_change_percent > 0 %}more{% elif active_change_percent < 0 %}less{% else %}same{% endif %} than last month</span>
                    </p>
                </div>
                <div class="h-14 w-14 bg-green-500 bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Total Orders -->
        <div class="bg-white rounded-lg shadow p-6 supplier-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Orders This Month</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">{{ orders_this_month }}</h3>
                    <p class="text-{% if orders_change_percent > 0 %}green{% elif orders_change_percent < 0 %}red{% else %}gray{% endif %}-500 text-sm font-medium mt-2">
                        <i class="fas fa-arrow-{% if orders_change_percent > 0 %}up{% elif orders_change_percent < 0 %}down{% else %}right{% endif %} mr-1"></i> {{ orders_change_percent_abs }}% <span class="text-gray-400">vs last month</span>
                    </p>
                </div>
                <div class="h-14 w-14 bg-blue-500 bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-blue-500 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Amount Spent -->
        <div class="bg-white rounded-lg shadow p-6 supplier-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Amount Spent (MTD)</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1">{{ amount_spent_mtd }}</h3>
                    <p class="text-{% if amount_change_percent > 0 %}green{% elif amount_change_percent < 0 %}red{% else %}gray{% endif %}-500 text-sm font-medium mt-2">
                        <i class="fas fa-arrow-{% if amount_change_percent > 0 %}up{% elif amount_change_percent < 0 %}down{% else %}right{% endif %} mr-1"></i> {{ amount_change_percent_abs }}% <span class="text-gray-400">vs last month</span>
                    </p>
                </div>
                <div class="h-14 w-14 bg-purple-500 bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-money-bill-wave text-purple-500 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Suppliers Table -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="flex justify-between items-center p-6 border-b">
            <h2 class="text-xl font-semibold">Suppliers Directory</h2>
            <form method="get" action="{% url 'webapp:suppliers' %}" class="relative">
                <input type="text" name="search" placeholder="Search suppliers..." class="px-4 py-2 border rounded-md pr-10" value="{{ search_query }}">
                {% if supplier_type_filter and supplier_type_filter != 'all' %}
                <input type="hidden" name="supplier_type" value="{{ supplier_type_filter }}">
                {% endif %}
                <button type="submit" class="absolute right-3 top-3 text-gray-400 border-0 bg-transparent" title="Search suppliers"><i class="fas fa-search"></i><span class="sr-only">Search suppliers</span></button>
            </form>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Person</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for supplier in suppliers %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-building text-primary"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ supplier.supplierName }}</div>
                                    <div class="text-sm text-gray-500">Supplier ID: {{ supplier.id|truncatechars:8 }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ supplier.supplierType }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ supplier.contactPerson }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ supplier.contactPhone|default:"N/A" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ supplier.contactEmail|default:"N/A" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ supplier.address|default:"N/A" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full {% if supplier.isDeleted %}tag-inactive{% else %}tag-active{% endif %}">
                                {% if supplier.isDeleted %}Inactive{% else %}Active{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editSupplier('{{ supplier.id }}')" title="Edit supplier"><i class="fas fa-edit"></i><span class="sr-only">Edit</span></button>
                            <button class="text-green-600 hover:text-green-900 mr-3" onclick="createOrder('{{ supplier.id }}')" title="Create order"><i class="fas fa-shopping-cart"></i><span class="sr-only">Create order</span></button>
                            <button class="text-red-600 hover:text-red-900" onclick="confirmDelete('{{ supplier.id }}')" title="Delete supplier"><i class="fas fa-trash"></i><span class="sr-only">Delete</span></button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                                <p>No suppliers found{% if search_query %} for "{{ search_query }}"{% endif %}.</p>
                                {% if search_query or supplier_type_filter != 'all' %}
                                <a href="{% url 'webapp:suppliers' %}" class="mt-2 text-primary-light font-medium hover:underline">Clear filters</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="py-4 px-6 bg-white border-t flex items-center justify-between">
            <div>
                {% if suppliers.paginator.count > 0 %}
                <p class="text-sm text-gray-500">Showing <span class="font-medium">{{ suppliers.start_index }}</span> to <span class="font-medium">{{ suppliers.end_index }}</span> of <span class="font-medium">{{ suppliers.paginator.count }}</span> suppliers</p>
                {% else %}
                <p class="text-sm text-gray-500">No suppliers found</p>
                {% endif %}
            </div>
            <div class="flex items-center space-x-2">
                {% if suppliers.has_previous %}
                <a href="{% url 'webapp:suppliers' %}?page={{ suppliers.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if supplier_type_filter != 'all' %}&supplier_type={{ supplier_type_filter }}{% endif %}" class="border rounded px-3 py-1 text-gray-700 hover:bg-gray-100" title="Previous page">Previous</a>
                {% else %}
                <button class="border rounded px-3 py-1 text-gray-500 bg-gray-100" disabled title="Previous page">Previous</button>
                {% endif %}
                
                {% for num in suppliers.paginator.page_range %}
                    {% if num == suppliers.number %}
                    <span class="border rounded px-3 py-1 text-white bg-primary">{{ num }}</span>
                    {% elif num > suppliers.number|add:'-3' and num < suppliers.number|add:'3' %}
                    <a href="{% url 'webapp:suppliers' %}?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if supplier_type_filter != 'all' %}&supplier_type={{ supplier_type_filter }}{% endif %}" class="border rounded px-3 py-1 text-gray-700 hover:bg-gray-100">{{ num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if suppliers.has_next %}
                <a href="{% url 'webapp:suppliers' %}?page={{ suppliers.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if supplier_type_filter != 'all' %}&supplier_type={{ supplier_type_filter }}{% endif %}" class="border rounded px-3 py-1 text-gray-700 hover:bg-gray-100" title="Next page">Next</a>
                {% else %}
                <button class="border rounded px-3 py-1 text-gray-500 bg-gray-100" disabled title="Next page">Next</button>
                {% endif %}
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize suppliers management functionality
        console.log("Suppliers management page loaded");
        
        // Add event listener for Add Supplier button
        document.getElementById('addSupplierBtn').addEventListener('click', function() {
            // Redirect to supplier creation form
            window.location.href = "{% url 'webapp:suppliers' %}?action=create";
        });
    });
    
    // Function to handle editing a supplier
    function editSupplier(supplierId) {
        // Redirect to the edit page with supplier ID
        window.location.href = "{% url 'webapp:suppliers' %}?action=edit&id=" + supplierId;
        alert('Edit supplier: ' + supplierId);
        // Future implementation could be:
        // window.location.href = "{% url 'webapp:suppliers' %}/" + supplierId + "/edit/";
    }
    
    // Function to handle creating a new order
    function createOrder(supplierId) {
        // For now, we'll just alert - in a real implementation this would open an order form
        alert('Create order for supplier: ' + supplierId);
        // Future implementation could be:
        // window.location.href = "{% url 'webapp:orders' %}?supplier=" + supplierId;
    }
    
    // Function to confirm supplier deletion
    function confirmDelete(supplierId) {
        if (confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) {
            // For now, we'll just alert - in a real implementation this would send an AJAX request
            alert('Supplier deleted: ' + supplierId);
            // Future implementation could be:
            // window.location.href = "{% url 'webapp:suppliers' %}/delete/" + supplierId + "/";
        }
    }
</script>
{% endblock %}
